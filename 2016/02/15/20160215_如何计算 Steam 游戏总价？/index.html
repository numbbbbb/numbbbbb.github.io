<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 买下 Steam 所有游戏要花多少钱？ · 梁杰的个人博客</title><meta name="description" content="买下 Steam 所有游戏要花多少钱？ - 梁杰"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/bloglogo.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/bloglogo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="http://weibo.com/numbbbbb" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="https://github.com/numbbbbb" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">买下 Steam 所有游戏要花多少钱？</h1><div class="post-time">Feb 15, 2016</div><div class="post-content"><p>先来看效果展示：<a href="http://steamtuhao.com" target="_blank" rel="external">买下 Steam 所有游戏要花多少钱？</a>。</p>
<h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="背景"></a>背景</h2><p>最近 Steam 玩得比较多，早晨突然想到一个有趣的问题：买下 Steam 所有游戏要花多少钱？</p>
<p>去 Google 了一下，发现国外有个网站做了计算，但是 2014 年底就停止更新了。研究了一下代码和 Steam API，自己做了一个网站来玩。</p>
<p>虽然没什么技术含量，但是很好的展示了<strong>如何把一个点子变成现实</strong>，所以记录下来。</p>
<a id="more"></a>
<h2 id="u6280_u80FD_u548C_u5DE5_u5177"><a href="#u6280_u80FD_u548C_u5DE5_u5177" class="headerlink" title="技能和工具"></a>技能和工具</h2><p>这个网站非常简单，涉及到的技术只要初步掌握即可实现。</p>
<blockquote>
<p>以下是我用到的技能和工具，你可以根据自己情况调整</p>
</blockquote>
<p>技能：</p>
<ul>
<li>Python</li>
<li>Node.js</li>
<li>基本的 HTML、CSS 和 JS</li>
<li>基本的 Linux 技能</li>
<li>基本的 Nginx 技能</li>
<li>翻墙能力</li>
<li>会用 GitHub</li>
</ul>
<p>工具：</p>
<ul>
<li>一台 VPS</li>
<li>一个域名</li>
<li>一个编辑器（我用的 Sublime Text 3）</li>
</ul>
<h2 id="u8C03_u67E5"><a href="#u8C03_u67E5" class="headerlink" title="调查"></a>调查</h2><p>首先去 Google 一下“How much to buy all steam games”，搜到这个网站：<a href="http://buyallofsteam.appspot.com/" target="_blank" rel="external">Buy All of Steam</a>，截图如下</p>
<p><img src="http://static.zybuluo.com/numbbbbb/pp7bbnnj7rdzji0614ogz456/1.png" alt="网站截图"></p>
<p>哇，九万多美元！真不少。</p>
<p>再往下看，最后一次更新时间是 2014 年光棍节。</p>
<p><img src="http://static.zybuluo.com/numbbbbb/letp7i9nq115kbfiswhhfplg/2.png" alt="ARE YOU KIDDING ME?"></p>
<p>是不是作者在光棍节脱单了所以放弃了 Steam？</p>
<p>继续往下看，网站还给出了计算方法，非常简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> steamapiwrapper.SteamGames <span class="keyword">import</span> Games</span><br><span class="line">games = Games()</span><br><span class="line">full_price = <span class="number">0.0</span></span><br><span class="line">discounted_price = <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> game <span class="keyword">in</span> games.get_all(<span class="string">'US'</span>):</span><br><span class="line">	<span class="keyword">if</span> game.price != <span class="number">0</span>:</span><br><span class="line">		discounted_price += game.discounted_price</span><br><span class="line">		full_price += game.full_price</span><br></pre></td></tr></table></figure>
<p>哇真的好简单！</p>
<p>然后我去看了一下这个<code>steamapiwrapper</code>库，</p>
<p><img src="http://static.zybuluo.com/numbbbbb/uv04h5jc39u6qruk7rngrcrr/3.png" alt="steamapiwrapper"></p>
<p>2 years ago</p>
<p>2 years ago</p>
<p>2 years ago</p>
<p>。</p>
<p>。</p>
<p>。</p>
<p>。</p>
<p>。</p>
<p>。</p>
<p>。</p>
<p><img src="http://static.zybuluo.com/numbbbbb/cqpgoa5p52xl6togf4t0bpnz/4.jpeg" alt="掀桌"></p>
<p>这就是网站作者自己写的库吧！一定是脱团之后弃坑了吧！！！</p>
<p>好吧，关掉网页，回到 Google 继续往下看。</p>
<p>嗯……没了。</p>
<p>其他的网页都是一些统计性质的文章，Steam 更新频率极高，这类文章基本上是一发表就过时。</p>
<p>怎么办？</p>
<p>作为无所不能的程序员，当然是自己写一个啦！既然两年前能实现，两年后一定也能搞定！</p>
<p><img src="http://static.zybuluo.com/numbbbbb/xfx3t0tlw9v5phljdjipg4jf/5.png" alt="接受挑战"></p>
<p>看看我们收集到了什么有用的东西：</p>
<ul>
<li>一段计算代码</li>
<li>一个 Steam API 库</li>
</ul>
<p>那就从这里开始吧。</p>
<h2 id="u4FEE_u6539_u4EE3_u7801"><a href="#u4FEE_u6539_u4EE3_u7801" class="headerlink" title="修改代码"></a>修改代码</h2><blockquote>
<p>以下代码<strong>不包含</strong>任何最佳实践，Just For Fun！</p>
</blockquote>
<p>首先来看看这段两年前的代码还能否运行，如果能，那我们只要写个网页展示就可以了。</p>
<p><code>steamapiwrapper</code>没有上传到 pip，所以我们只能下载代码到本地。</p>
<p>首先登陆 VPS:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@xxx.xxx.xx.x</span><br></pre></td></tr></table></figure>
<blockquote>
<p>提示：本文的命令和代码是意识流，重在介绍思想和流程，具体的细节请自行 Google（别百度，百度一下你就被坑）。</p>
</blockquote>
<p>然后用<code>virtualenv</code>创建 Python 虚拟环境，不影响本机的 Python 配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /steamtuhao</span><br><span class="line">$ <span class="built_in">cd</span> /steamtuhao</span><br><span class="line">$ pip install virtualenv</span><br><span class="line">$ virtualenv venv</span><br><span class="line">$ virtualenv -p /usr/bin/python2.<span class="number">7</span> venv</span><br></pre></td></tr></table></figure>
<p>执行完会在根目录下的<code>steamtuhao</code>目录中创建一个 Python 虚拟环境，并且指定 Python 版本为 2.7（<code>steamapiwrapper</code>基于 Python 2.x 开发）。</p>
<p>然后开启虚拟环境，下载第三方库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> venv/bin/activate</span><br><span class="line">$ git <span class="built_in">clone</span> git@github.com:naiyt/steamapiwrapper.git</span><br><span class="line">$ cp -avr steamapiwrapper/steamapiwrapper ./temp</span><br><span class="line">$ rm -rf steamapiwrapper</span><br><span class="line">$ mv temp steamapiwrapper</span><br></pre></td></tr></table></figure>
<p>最后三行是不是看懵了？GitHub 克隆下来的库并不能直接导入 Python 中，需要把里面真正的 Python 包复制出来。所以这里的操作其实是：复制出来我们要用的包、删掉整个项目、重命名包。</p>
<p>最后新建一个文件，把网站中提到的那段代码复制进去：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要复制的代码</span></span><br><span class="line"><span class="keyword">from</span> steamapiwrapper.SteamGames <span class="keyword">import</span> Games</span><br><span class="line">games = Games()</span><br><span class="line">full_price = <span class="number">0.0</span></span><br><span class="line">discounted_price = <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> game <span class="keyword">in</span> games.get_all(<span class="string">'US'</span>):</span><br><span class="line">	<span class="keyword">if</span> game.price != <span class="number">0</span>:</span><br><span class="line">		discounted_price += game.discounted_price</span><br><span class="line">		full_price += game.full_price</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim calTotalPrices.py</span><br><span class="line"><span class="comment"># 进入 vim </span></span><br><span class="line"><span class="comment"># 粘贴上面的代码并保存</span></span><br></pre></td></tr></table></figure>
<p>OK，运行一下试试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python calTotalPrices.py</span><br></pre></td></tr></table></figure>
<p>报错了。</p>
<p>具体的错误信息我忘了保存，大概就是说 JSON 不能解析<code>None</code>。打开出错的<code>SteamGames.py</code>定位过去看下，发现调用了一个<code>_open_url</code>函数，搜索一下这个函数看看…………</p>
<p><del>没找到。</del></p>
<p><del>这哥们绝对是恋爱了，否则不可能犯这么弱智的错误。</del></p>
<blockquote>
<p>经过@Ralph-Wang 提醒，发现<code>_open_url</code>是继承自<code>SteamBase.py</code>中的<code>SteamAPI</code>类。那应该和下面提到的问题一样，因为 URL 里面编码了参数，导致请求返回 null。</p>
</blockquote>
<p>好吧，看上下文，这里应该是请求一个 URL 并解析返回的 JSON 内容。</p>
<p>那我们直接用<code>requests</code>这个库就行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install requests</span><br></pre></td></tr></table></figure>
<p>然后修改<code>SteamGames.py</code>文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件头部 import 进来</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把两处 _open_url 都改过来</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_games_from</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        <span class="string">"""Generator to create the actual game objects"""</span></span><br><span class="line">        page = requests.get(url).json()    <span class="comment"># ←第一处</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ids_and_names</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Returns two dicts: one mapping appid-&gt;game name, and one game name-&gt;appid</span><br><span class="line">        TODO: Refactor the code so we don't need to seperate dicts</span><br><span class="line"></span><br><span class="line">        """</span></span><br><span class="line">        url = <span class="string">"http://api.steampowered.com/ISteamApps/GetAppList/v2"</span></span><br><span class="line">        url_info = requests.get(url).json()    <span class="comment"># ←第二处</span></span><br></pre></td></tr></table></figure>
<p>OK，现在再来跑一下看看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python calTotalPrices.py</span><br></pre></td></tr></table></figure>
<p>又报错了。</p>
<p>具体的错误信息我没保存（为什么这句话这么眼熟），反正大概意思就是 JSON 不能解析<code>None</code>。什么？刚才不就是这个错误吗？！</p>
<p>仔细看了一下，错误位置和上次一样，到底是怎么回事？</p>
<p>回答这个问题之前先来了解下请求 URL 时到底发生了什么：</p>
<ul>
<li>访问 URL</li>
<li>服务器返回 JSON 数据</li>
<li>拿到返回的数据并解析</li>
</ul>
<p>我们刚才解决的是第一步，访问 URL。现在又出错了，那就说明返回的 JSON 数据有问题。</p>
<p>可以在代码里加一个<code>print page</code>看下，果然是<code>None</code>，也就是说根本就没拿到数据。</p>
<p>怎么回事呢？我们再<code>print url</code>一下，我看到的是这个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://store.steampowered.com/api/appdetails/?cc=US&#38;appids=5%2C262150%2C7%2C8%2C10%2C20%2C393240%2C30%2C40%2C262190%2C50%2C393270%2C60%2C262210%2C70%2C393290%2C80%2C262230%2C90%2C92%2C262240%2C100%2C393320%2C393330%2C262260&#38;l=english&#38;v=1</span><br></pre></td></tr></table></figure>
<p>这<code>appids</code>肯定有问题啊！</p>
<p><code>print all_ids</code>，从里面拿出来一个 id，手动拼接到上面的 URL 中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://store.steampowered.com/api/appdetails/?appids=218620&#38;cc=US&#38;l=english&#38;v=1</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/numbbbbb/itesja11wq5cd5d36waojc90/6.png" alt="访问结果"></p>
<p>拿到了数据，看来就是 URL 拼接时候出问题了。</p>
<p>看下拼接函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_url</span><span class="params">(self, appids, cc)</span>:</span></span><br><span class="line">    <span class="string">"""Given a list of appids, creates an API url to retrieve them"""</span></span><br><span class="line">    appids = <span class="string">','</span>.join([str(x) <span class="keyword">for</span> x <span class="keyword">in</span> appids])</span><br><span class="line">    data = &#123;<span class="string">'appids'</span>: appids, <span class="string">'cc'</span>: cc, <span class="string">'l'</span>: <span class="string">'english'</span>, <span class="string">'v'</span>: <span class="string">'1'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"http://store.steampowered.com/api/appdetails/?&#123;&#125;"</span>.format(urllib.urlencode(data))</span><br></pre></td></tr></table></figure>
<p>为什么要<code>urlencode</code>呢？删掉，直接手动拼接：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_url</span><span class="params">(self, appids, cc)</span>:</span></span><br><span class="line">    <span class="string">"""Given a list of appids, creates an API url to retrieve them"""</span></span><br><span class="line">    appids = <span class="string">','</span>.join([str(x) <span class="keyword">for</span> x <span class="keyword">in</span> appids])</span><br><span class="line">    data = (appids, cc, <span class="string">'english'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"http://store.steampowered.com/api/appdetails/?appids=%s&amp;cc=%s&amp;l=%s&amp;v=1"</span> % data</span><br></pre></td></tr></table></figure>
<p>再执行一下，还是报错。</p>
<p>好吧，就是这样的，现在你知道两年前的项目是什么概念了。</p>
<p>刚才我们在浏览器里不是拿到数据了吗？怎么又出问题了？</p>
<p>仔细看下拼接的 URL，发现有个区别：拼接的 URL 里有多个<code>appid</code>，我们刚才只试了一个。</p>
<p>修改测试 URL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://store.steampowered.com/api/appdetails/?appids=218620,441600&#38;cc=US&#38;l=english&#38;v=1</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/numbbbbb/mkir67whv2z73jn6svioiznw/7.png" alt="测试"></p>
<p>果然，返回 null。</p>
<p>到底是怎么回事？</p>
<p>再次阅读<code>steamapiwrapper</code>的文档，发现作者提到了一篇文章，说他用文章里的方法重构了 API，我们去看看<a href="https://steamdb.info/blog/store-prices-api/" target="_blank" rel="external">那篇文章</a>。</p>
<p>打开一看，说的就是我们这个 API 啊！往下翻，看到好多两年前的评论，再往下翻，最底部的一条评论是五个月前的，看看说了什么：</p>
<p><img src="http://static.zybuluo.com/numbbbbb/5tjif2qijoxk4apy9sobxnda/8.png" alt="评论"></p>
<p>热泪盈眶！兄弟你是个好人啊！！不仅发现了这个问题，还给出了解决方法！</p>
<p>把<code>&amp;filters=price_overview</code>加到 URL 结尾看看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://store.steampowered.com/api/appdetails/?appids=218620,441600&#38;cc=US&#38;l=english&#38;v=1&#38;filters=price_overview</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/numbbbbb/0sfgqfbr4xv1wfcdz20e1wsy/9.png" alt="测试"></p>
<p>热泪盈眶 again！数据出来了，而且正是我们想要的价格数据！</p>
<p>这里做个笔记，返回的数据中<code>currency</code>表示货币种类，<code>initial</code>表示原价，<code>final</code>表示折扣价。哎这游戏怎么这么贵？1999 美元？打开 Steam 搜了一下，是 19.99 美元，明白了，这个数字要除以 100 才是实际价格。</p>
<blockquote>
<p>科普：为什么 Steam 要乘以 100？</p>
<p>在很多语言中 0.1 + 0.1 都不等于 0.2，这是因为计算机本身的设计缺陷，无法准确保存浮点数（也就是小数），因此对浮点数做运算会有误差。最简单的解决办法就是把浮点数变成整数进行运算，最终需要展示时再除回小数。</p>
<p>如果你想了解更多浮点数内容，可以阅读<a href="https://www.zhihu.com/question/20679634" target="_blank" rel="external">逼乎上的答案</a>。</p>
</blockquote>
<p>下面继续修改代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_url</span><span class="params">(self, appids, cc)</span>:</span></span><br><span class="line">    <span class="string">"""Given a list of appids, creates an API url to retrieve them"""</span></span><br><span class="line">    appids = <span class="string">','</span>.join([str(x) <span class="keyword">for</span> x <span class="keyword">in</span> appids])</span><br><span class="line">    data = (appids, cc, <span class="string">'english'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"http://store.steampowered.com/api/appdetails/?appids=%s&amp;cc=%s&amp;l=%s&amp;v=1&amp;filters=price_overview"</span> % data</span><br></pre></td></tr></table></figure>
<p>再次运行，又报错了，错误提示不一样了！可喜可贺。</p>
<p>具体的错误提示我忘了（……），反正大概是说<code>Game</code>类初始化时候有问题。</p>
<p>看一下出错位置的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> appid <span class="keyword">in</span> page:</span><br><span class="line">	game = Game(page[appid], appid)</span><br><span class="line">	<span class="keyword">if</span> game.success:</span><br><span class="line">	    <span class="keyword">yield</span> game</span><br></pre></td></tr></table></figure>
<p>这里的<code>page</code>是一个解析后的 JSON 内容，也就是说它是一个字典。用<code>for</code>循环去遍历的时候，拿到的<code>appid</code>是字典的键，传入<code>Game</code>类生成实例的时候出错了。跳过去看了一下<code>Game</code>类的实现代码，好麻烦，懒得改了，反正已经拿到价格数据，直接返回得了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_games_from</span><span class="params">(self, url)</span>:</span></span><br><span class="line">    <span class="string">"""Generator to create the actual game objects"""</span></span><br><span class="line">    page = requests.get(url).json()</span><br><span class="line">    <span class="keyword">for</span> game <span class="keyword">in</span> page:</span><br><span class="line">        <span class="keyword">if</span> page[game][<span class="string">'success'</span>] <span class="keyword">and</span> page[game][<span class="string">'data'</span>]:</span><br><span class="line">            <span class="keyword">yield</span> page[game][<span class="string">'data'</span>][<span class="string">'price_overview'</span>]</span><br></pre></td></tr></table></figure>
<p>再重复一遍，page 是字典，所以要用方括号去获取内容。</p>
<p>测试的时候发现有时候请求成功但是<code>data</code>是空，所以<code>if</code>中加了一个判断条件。</p>
<p>由于返回的内容改变，我们还需要修改<code>calTotalPrices.py</code>里面的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> steamapiwrapper.SteamGames <span class="keyword">import</span> Games</span><br><span class="line">games = Games()</span><br><span class="line">full_price = <span class="number">0.0</span></span><br><span class="line">discounted_price = <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> game <span class="keyword">in</span> games.get_all(<span class="string">'US'</span>):</span><br><span class="line">	<span class="keyword">if</span> game[<span class="string">'initial'</span>] != <span class="number">0</span>:</span><br><span class="line">		discounted_price += game[<span class="string">'final'</span>]</span><br><span class="line">		full_price += game[<span class="string">'initial'</span>]</span><br><span class="line">		<span class="keyword">print</span> full_price, discounted_price</span><br></pre></td></tr></table></figure>
<p>再次运行程序，这次没有报错，并且一直在输出价格，大功告成！</p>
<p>这一节写了好长，终于能结束了。</p>
<h2 id="u9A8C_u8BC1"><a href="#u9A8C_u8BC1" class="headerlink" title="验证"></a>验证</h2><p>代码跑通了，下面就是要检查数据是否正确。</p>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python calTotalPrices.py</span><br></pre></td></tr></table></figure>
<p>一开始没问题，过了一会又报错了。</p>
<p><img src="http://static.zybuluo.com/numbbbbb/letp7i9nq115kbfiswhhfplg/2.png" alt="ARE YOU KIDDING ME?"></p>
<p>不是没问题了吗？</p>
<p>这时候，经验丰富的同学应该已经想到了一种可能性：API 调用频率限制。</p>
<p>没错，Steam 不是慈善家，API 资源不可能给你无限使用。经过一番研究，发现确实是触发了 API 的限制。一旦访问频率过快，Steam 会直接返回 null。</p>
<p>那么 Steam 的限制到底是多少？</p>
<p>Google 一番之后，发现 Steam 官方没有任何说明。聪明的网友们自己总结出几条规则：</p>
<ul>
<li>10 秒内最多调用 10 次</li>
<li>5 分钟内最多调用 200 次</li>
<li>x 分钟内……</li>
</ul>
<p>好了好了我明白了，总之一秒调用一次肯定没问题是吧？简单，加个<code>sleep(1)</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    <span class="keyword">for</span> game <span class="keyword">in</span> self._get_games_from(url):</span><br><span class="line">        <span class="keyword">yield</span> game</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>加完之后，经验丰富的同学应该又想到了另一个问题：要抓多久？</p>
<p><code>print len(all_ids)</code>，大概有 23000 个 id，代码中<code>self.num = 25</code>，每次请求查询 25 个，需要查询 23000/25 = 1000 次。每次请求睡眠一秒，那就是 1000 多秒，大概 17 分钟。再加上请求本身需要的时间，可能要几十分钟吧。</p>
<p>看起来也可以接受，不过还能优化吗？</p>
<p>仔细看代码中的注释：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,num=None)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    args:</span><br><span class="line">    num -- number of games to query per call. The default 150 should work in most cases.</span><br><span class="line"></span><br><span class="line">    """</span></span><br><span class="line">    self.num = <span class="number">25</span> <span class="keyword">if</span> num <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">else</span> num</span><br></pre></td></tr></table></figure>
<p>原来默认值是 150 啊，那我们就改成<code>self.num = 150</code>，一下快了 6 倍，好开心。</p>
<p>下面就来正式运行一下，看看能否拿到数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nohup python calTotalPrices.py &gt; result &amp;</span><br></pre></td></tr></table></figure>
<p>咦，怎么出来一个<code>nohup</code>？这是一个新命令，简单来说就是后台执行。这条命令把输出写到<code>result</code>文件中，结尾的<code>&amp;</code>会让进程在后台持续运行，哪怕 ssh 断掉进程也不会中止。</p>
<p>然后等就可以了，什么时候程序执行完了，什么时候拿到结果。</p>
<p>等几分钟就跑完了，看看总价：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15031825 14903412</span><br></pre></td></tr></table></figure>
<p>哇，真不少啊！十五万美元！</p>
<p>现在已经解决了我的问题，算出了总价。不过我还想做得更多，能不能让其他人也看到这个数据呢？</p>
<p>当然能，做个网站就可以了。</p>
<h2 id="u5C55_u793A"><a href="#u5C55_u793A" class="headerlink" title="展示"></a>展示</h2><p>现在已经拿到数据了，接下来要做的是展示数据。</p>
<p>我们从用户的角度来思考，他们如何查看数据？</p>
<ul>
<li>访问一个 URL，因此需要<strong>注册一个域名</strong></li>
<li>请求会发送到后端服务器，因此需要<strong>准备一个 VPS</strong></li>
<li>VPS 需要处理请求，因此需要<strong>配置 Nginx</strong></li>
<li>Nginx 拿到请求之后要反向代理给具体的处理者，因此需要<strong>编写一个 Node.js 程序</strong></li>
<li>Node.js 程序需要返回一个页面，因此需要<strong>编写一个 HTML 页面</strong></li>
</ul>
<p>OK，就是这些，涉及到很多东西，但是都不难。具体实施的时候顺序稍有不同，我们一步一步说。</p>
<h3 id="u6CE8_u518C_u4E00_u4E2A_u57DF_u540D"><a href="#u6CE8_u518C_u4E00_u4E2A_u57DF_u540D" class="headerlink" title="注册一个域名"></a>注册一个域名</h3><p>具体教程自己 Google，一般注册域名国内去万网，国外去<a href="https://www.godaddy.com/" target="_blank" rel="external">GoDaddy</a>，<a href="https://www.name.com/" target="_blank" rel="external">Name</a>。</p>
<p>买好域名之后，把域名解析到自己的 VPS IP 地址就可以了。</p>
<h3 id="u51C6_u5907_u4E00_u4E2A_VPS"><a href="#u51C6_u5907_u4E00_u4E2A_VPS" class="headerlink" title="准备一个 VPS"></a>准备一个 VPS</h3><p>VPS 是另一个话题，你问我资词哪个？我主要用 Linode 和阿里云。不过要注意，大陆的主机要求域名备案，不备案的域名不能解析到大陆主机。所以如果你域名没备案，去买香港或者新加坡的主机，阿里云有，UCloud 也有，很多家都有。还可以买日本和欧美主机，不过速度比较慢。</p>
<h3 id="u7F16_u5199_u4E00_u4E2A_HTML__u9875_u9762"><a href="#u7F16_u5199_u4E00_u4E2A_HTML__u9875_u9762" class="headerlink" title="编写一个 HTML 页面"></a>编写一个 HTML 页面</h3><p>由于只需要展示数字，所以直接编写一个带占位符的简单页面就可以：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span> <span class="attribute">lang</span>=<span class="value">"zh-CN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">title</span>&gt;</span>买下 Steam 所有游戏要花多少钱？<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"viewport"</span> <span class="attribute">content</span>=<span class="value">"width=device-width, initial-scale=1,user-scalable=no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">style</span> <span class="attribute">type</span>=<span class="value">"text/css"</span>&gt;</span><span class="css"></span><br><span class="line">    ... 省略，可以直接查看我的网站源码</span><br><span class="line">    </span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"main"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">h2</span>&gt;</span>买下Steam所有游戏需要<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">h1</span>&gt;</span>$&#123;dollar&#125; 或 ￥&#123;cny&#125;<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">h4</span>&gt;</span>共有<span class="tag">&lt;/<span class="title">h4</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">h1</span>&gt;</span>&#123;us_number&#125;(美区),&#123;cn_number&#125;(中区)个游戏和 DLC！<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">p</span> <span class="attribute">class</span>=<span class="value">"date"</span>&gt;</span>更新日期：&#123;date&#125;<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"http://numbbbbb.com/2016/02/15/20160215_%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%20Steam%20%E6%B8%B8%E6%88%8F%E6%80%BB%E4%BB%B7%EF%BC%9F/"</span>&gt;</span>原理详解<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"footer"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">span</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"http://numbbbbb.com"</span>&gt;</span>作者@梁杰_numbbbbb<span class="tag">&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="title">span</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意到里面有几个奇怪的东西，那些是占位符，Node.js 中会读取 Python 执行出来的结果并替换掉，用户看到的网页显示的是实际数字。</p>
<blockquote>
<p>你可以根据自己的喜好调整页面样式。</p>
</blockquote>
<h3 id="u7F16_u5199_u4E00_u4E2A_Node-js__u7A0B_u5E8F"><a href="#u7F16_u5199_u4E00_u4E2A_Node-js__u7A0B_u5E8F" class="headerlink" title="编写一个 Node.js 程序"></a>编写一个 Node.js 程序</h3><p>首先配置好 Node.js 环境以及 npm，不会的自行 Google。</p>
<p>这里用到了<code>hapi</code>，一个 Node.js 服务端框架，专门用来处理网络请求。还用到了<code>pm2</code>，你可以把它理解成一个监控程序，它会帮你监控进程是否正常运行，并在必要的时候重启进程，这样你的服务就不会轻易狗带。我喜欢 ES6，所以需要安装<code>babel-cli</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install pm2 babel-cli -g</span><br><span class="line">$ sudo npm install hapi</span><br></pre></td></tr></table></figure>
<p>由于<code>babel-cli</code>和<code>pm2</code>都需要执行命令行命令，所以全局安装。</p>
<p>下面创建 Node.js 程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ touch index.js</span><br><span class="line">$ vim index.js</span><br></pre></td></tr></table></figure>
<p>拷贝进去下面的代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env babel-node</span><br><span class="line">import Hapi from 'hapi'</span><br><span class="line">import fs from 'fs'</span><br><span class="line"></span><br><span class="line">let server = new Hapi.Server()</span><br><span class="line">server.connection(&#123;</span><br><span class="line">  port: 3003,</span><br><span class="line">  routes: &#123;</span><br><span class="line">    cors: &#123;</span><br><span class="line">      origin: ['*']</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">function numberWithCommas(x) &#123;</span><br><span class="line">    var parts = x.toString().split(".");</span><br><span class="line">    parts[0] = parts[0].replace(/\B(?=(\d&#123;3&#125;)+(?!\d))/g, ",");</span><br><span class="line">    return parts.join(".");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server.route(&#123;</span><br><span class="line">  method: 'GET',</span><br><span class="line">  path: '/',</span><br><span class="line">  handler: (request, reply) =&gt; &#123;</span><br><span class="line">    fs.readFile("finalResult", (err, data) =&gt; &#123;</span><br><span class="line">      if (err) throw err</span><br><span class="line">      let rawData = data.toString().split('\n')</span><br><span class="line">      fs.stat("finalResult", (err, data) =&gt; &#123;</span><br><span class="line">        let mtime = data.mtime</span><br><span class="line">        fs.readFile("index.html", (err, data) =&gt; &#123;</span><br><span class="line">          var result = data.toString()</span><br><span class="line">          result = result.replace("&#123;dollar&#125;", numberWithCommas(parseInt(rawData[1]) / 100))</span><br><span class="line">          result = result.replace("&#123;cny&#125;", numberWithCommas(parseInt(rawData[4]) / 100))</span><br><span class="line">          result = result.replace("&#123;us_number&#125;", numberWithCommas(rawData[2]))</span><br><span class="line">          result = result.replace("&#123;cn_number&#125;", numberWithCommas(rawData[5]))</span><br><span class="line">          result = result.replace("&#123;date&#125;", mtime.toISOString())</span><br><span class="line">          reply(result).code(200)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.start((err) =&gt; &#123;</span><br><span class="line">  console.log(err)</span><br><span class="line">  console.log('Server running at:', server.info.uri)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>再次重复，本文的代码<strong>不包含</strong>任何最佳实践，Just For Fun！</p>
<p>这段代码很简单，启动一个服务器监听 3003 端口，如果有请求过来，就直接读取上面的 HTML 文件，用最新的数据替换掉 HTML 中的占位符，然后返回。</p>
<h3 id="u914D_u7F6E_Nginx"><a href="#u914D_u7F6E_Nginx" class="headerlink" title="配置 Nginx"></a>配置 Nginx</h3><p>在 VPS 上安装和配置 Nginx。别问我怎么安装，问 Google。</p>
<p>打开配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>
<p>添加一段内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server &#123;&#10;  listen 80;&#10;  server_name steamtuhao.com www.steamtuhao;    # &#8592;&#20889;&#20320;&#30340;&#22495;&#21517;&#10;&#10;  location / &#123;&#10;    proxy_pass http://127.0.0.1:3003;    # &#8592;&#20889;&#20320;&#30340;&#31471;&#21475;&#10;    proxy_http_version 1.1;&#10;    proxy_set_header Upgrade $http_upgrade;      &#10;    proxy_set_header Connection &#39;upgrade&#39;;&#10;    proxy_set_header Host $host;&#10;    proxy_cache_bypass $http_upgrade;&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>注意两个地方，一个是域名，一个是端口。</p>
<p>当然，我们还没说到域名，先往下翻，看域名那一节，搞定域名再来这里配置。</p>
<p>写完之后重启 Nginx：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service nginx restart</span><br></pre></td></tr></table></figure>
<p>看到输出<code>[OK]</code>就表示重启成功，配置没问题。如果不写域名这里会出错。</p>
<h3 id="Burst_Link_uFF01"><a href="#Burst_Link_uFF01" class="headerlink" title="Burst Link！"></a>Burst Link！</h3><p>别问我标题什么意思，反正看 Link 也能猜到，就是把各个部分连接起来。</p>
<p>现在已经有了：</p>
<ul>
<li>域名</li>
<li>VPS</li>
<li>Nginx</li>
<li>HTML 页面</li>
<li>Node.js 程序</li>
</ul>
<p>并且域名已经解析到 VPS、Nginx 已经配置好，只差最后一步，用<code>pm2</code>运行你的 Node.js 程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pm2 start index.js --interpreter babel-node</span><br></pre></td></tr></table></figure>
<p>由于我使用了 ES6，所以要把解释器设置成<code>babel-node</code>。</p>
<p>执行完这一步就可以了，现在用户可以访问你的 URL，请求会被发送到 VPS，VPS 上的 Nginx 接收到请求之后会转发给 Node.js 程序，这个程序会读取数字、替换占位符并返回最终的 HTML。</p>
<p>好了，展示部分已经搞定。下面还有最后一个任务：自动更新数据。</p>
<h2 id="Final_Round_21"><a href="#Final_Round_21" class="headerlink" title="Final Round!"></a>Final Round!</h2><p>首先来修改我们的计算脚本，让它把<strong>美元总价</strong>、<strong>人民币总价</strong>、<strong>游戏和 DLC 总数</strong>以及<strong>修改日期</strong>写入<code>finalResult</code>文件，一个一行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> steamapiwrapper.SteamGames <span class="keyword">import</span> Games</span><br><span class="line">games = Games()</span><br><span class="line">us_full_price = <span class="number">0</span></span><br><span class="line">us_discounted_price = <span class="number">0</span></span><br><span class="line">us_gameTotal = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> game <span class="keyword">in</span> games.get_all(<span class="string">'US'</span>):</span><br><span class="line">	<span class="keyword">if</span> game[<span class="string">'initial'</span>] != <span class="number">0</span>:</span><br><span class="line">		us_gameTotal += <span class="number">1</span></span><br><span class="line">		us_discounted_price += game[<span class="string">'final'</span>]</span><br><span class="line">		us_full_price += game[<span class="string">'initial'</span>]</span><br><span class="line"></span><br><span class="line">cn_full_price = <span class="number">0</span></span><br><span class="line">cn_discounted_price = <span class="number">0</span></span><br><span class="line">cn_gameTotal = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> game <span class="keyword">in</span> games.get_all(<span class="string">'CN'</span>):</span><br><span class="line">	<span class="keyword">if</span> game[<span class="string">'initial'</span>] != <span class="number">0</span>:</span><br><span class="line">		cn_gameTotal += <span class="number">1</span></span><br><span class="line">		cn_discounted_price += game[<span class="string">'final'</span>]</span><br><span class="line">		cn_full_price += game[<span class="string">'initial'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"\n"</span>.join([str(us_full_price), str(us_discounted_price), str(us_gameTotal), str(cn_full_price), str(cn_discounted_price), str(cn_gameTotal)])</span><br></pre></td></tr></table></figure>
<p>我承认上面的代码很蠢，或许下一个版本我会重构，现在嘛，Just For Fun!</p>
<p>分别计算美元和人民币的价格，然后输出。注意输出顺序要和前面的 Node.js 程序对应。</p>
<p>最后写一个 Linux 的 crontab 命令，每天半夜 12 点自动执行一遍这个程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crontab <span class="operator">-e</span></span><br><span class="line"><span class="comment"># 执行之后会打开一个文件，在文件倒数第二行写入以下内容</span></span><br><span class="line"><span class="number">0</span> <span class="number">23</span> * * * <span class="built_in">cd</span> /steamtuhao &amp;&amp; python calTotalPrices.py &gt; result &amp;&amp; mv finalResult finalResult.bak &amp;&amp; mv result finalResult</span><br></pre></td></tr></table></figure>
<p>这里有个坑，注意，是写到<strong>倒数第二行</strong>，这个文件结尾必须有一个空行！如果写到最后一行无法执行。</p>
<p>是不是很奇怪？我个人认为这是 Linux 的一个脑残之处。执行<code>man crontab</code>，手册中有一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cron requires that each entry in a crontab end in a newline character. &#10;If the last entry in a crontab is missing the newline,&#10;cron  will  consider the crontab (at least partially) broken and refuse to install it.</span><br></pre></td></tr></table></figure>
<p>这句话的意思是说：最后一行必须是空行，否则最后一个任务无法执行。</p>
<p>没有任何解释，反正就是无法执行。难以想象，一个 21 世纪的 Linux 系统居然连空行问题都处理不了！</p>
<p>无论如何，一定要记住，<strong>crontab 文件结尾必须有空行</strong>。</p>
<p>好了，现在你已经完成了所有步骤，把域名发给你的朋友吧！</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>早晨开始写代码，中午开始写博客，这一切都在一天之内搞定。再次重申，文章中的代码并不好，因为代码本来就不是重点，重点是这个过程带给了我很多乐趣！</p>
<p>我一直觉得编程和写作、绘画一样，是一种创造的过程。我喜欢编程，我可以用它实现我的各种奇思妙想，我很享受这个过程。</p>
<p>希望你也能享受编程。</p>
<h2 id="u5173_u4E8E_u6211"><a href="#u5173_u4E8E_u6211" class="headerlink" title="关于我"></a>关于我</h2><p>这一部分是最不重要的，因此放在最后。</p>
<p>如果你真的读到了这里，想必对这个喋喋不休的家伙有些兴趣。</p>
<p>我是梁杰，90 后，职业前端，业余 iOS，业余 Python，翻译过多本书。如果你想了解更多信息，可以访问以下链接：</p>
<ul>
<li><a href="http://numbbbbb.com" target="_blank" rel="external">我的博客</a>，最近才开始重建，内容不多，不过绝对有趣</li>
<li><a href="https://github.com/numbbbbb" target="_blank" rel="external">GitHub</a>，或许你点开就会发现“哦原来是你！”</li>
</ul>
<h2 id="u5F00_u6E90_uFF1F"><a href="#u5F00_u6E90_uFF1F" class="headerlink" title="开源？"></a>开源？</h2><p>当然会开源啦！</p>
<p>不过这个项目的代码太丑，开源出去只会误导新手，所以暂时不开。如果我还有精力和兴趣，会重构甚至重写这个项目，不过现在嘛……我要去休息了。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/28/20160328_我如何用两周时间刷完 SICP/" class="prev">上一篇</a><a href="/2016/01/14/hello-world/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'numbbbbb';
var disqus_identifier = '2016/02/15/20160215_如何计算 Steam 游戏总价？/';
var disqus_title = '买下 Steam 所有游戏要花多少钱？';
var disqus_url = 'http://yoursite.com/2016/02/15/20160215_如何计算 Steam 游戏总价？/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//numbbbbb.disqus.com/count.js" async></script><div class="copyright"><p>© undefined - 2018 <a href="http://yoursite.com">梁杰</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-72406781-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>